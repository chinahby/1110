#! /usr/bin/env perl

#############################################################################
#
#                            M D E P E N D
#
# GENERAL DESCRIPTION
#   Merge dependencies generated by getdep.pl into the real makefile.
#
#   The makefile is searched for a line beginning with
#    # DO NOT EDIT BELOW THIS LINE
#   All lines below this line are removed and the dependencies are
#   placed at this point.
#
# INVOCATION
#   perl mdepend.pl target.mak TARGET LIBDIR
#
# Copyright (c) 1998, 1999 by QUALCOMM Incorporated.  All Rights Reserved.
# Copyright (c) 2006, 2008 by QUALCOMM Incorporated.  All Rights Reserved.
#############################################################################
#
#                        EDIT HISTORY FOR FILE
#
# $Header: //depot/asic/msmshared/secboot2/shared/1_0/tools/mdepend.pl#2 $
#
# when       who     what, where, why
# --------   ---     --------------------------------------------------------
# 04/09/08   mjs     Remove $(BUILD) replacements for linux compatibility.
#                    Not needed when dependency file is build-ID-specific.
# 10/16/06   amw     Do not use absolute paths and fix slashes properly.
# 08/17/06   amw     Correct extraneous replacements with $(BUILD).
# 03/03/06   amw     Collect dependencies from option library directory.
# 10/13/98   dlb     Initial version.
#
#############################################################################

die "Usage: perl mdepend.pl target.mak TARGET <LIBDIR>\n"
    unless ($#ARGV == 1) || ($#ARGV == 2);


$makefile = $ARGV[0];
$target   = $ARGV[1];
if ( $#ARGV == 2 ) {
   $libdir = $ARGV[2];
}

############################################################
# Begin by copying the normal part of the makefile.
############################################################

$found_line = 0;

open (IN, "<$makefile") || die "Can't read makefile\n";
while (<IN>) {
  if (/^\# DO NOT EDIT BELOW THIS LINE/) {
    print;
    $found_line = 1;
    last;
  }
  print;
}
close (IN);

die "No '# DO NOT EDIT BELOW THIS LINE' found in makefile\n"
    unless $found_line;

############################################################
# Now merge in the dependencies.
############################################################

for $name (<$target/*.dep>) {
  open (IN, "<$name") || die "Can't read file: $name";
  print "\n";
  while (<IN>) {

    # Skip the line if it has an absolute path.
    # i.e. c:/Apps/RVDS210/RVCT/Data/2.1/328/include/windows/string.h
    next if (/\:.*\:/);

    # Change \ to / for compatibility
    s/\\/\//g;

    print;
  }
  close IN;
}

############################################################
# Now merge in the library dependencies if they exist
############################################################

if ( defined($libdir) ) {

   for $name (<$libdir/*.dep>) {
     open (IN, "<$name") || die "Can't read file: $name";
     print "\n";
     while (<IN>) {

       # Skip the line if it has an absolute path.
       # i.e. c:/Apps/RVDS210/RVCT/Data/2.1/328/include/windows/string.h
       next if (/\:.*\:/);

       # Change \ to / for compatibility
       s/\\/\//g;

       print;
     }
     close IN;
   }

}
print "\n# End of auto generated dependencies.\n";

###########################################################################
# End of Perl script.
###########################################################################
